4.Настоящие ходы

Дана позиция.
Необходимо сгенерировать все допустимые ходы для той стороны, чей сейчас ход.
Нужно сделать проверку на шах, в списке должны остаться только корректные ходы, 
после которых король находится в безопасности (не под шахом).

Дополнительные правила для рокировки.
1. Если объявлен шах, то рокировку делать нельзя.
2. Поле, через которое "перепрыгивает" король не должно быть под шахом 
(по-другому: в списке допустимых ходов должен быть ход королём на это поле).
3. После рокировки король не должен оказаться под шахом.

Дано: FEN-позиция.
Надо: Вывести количество допустимых ходов и их список.